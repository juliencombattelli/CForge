function(_cforge_unit_test_fn)
    # TODO Use TEST_SUITE and TEST_CASE to automatically search for the scripts
    set(ARG_TEST_SHALL_FAIL @ARG_TEST_SHALL_FAIL@)
    set(ARG_TEST_SUITE @ARG_TEST_SUITE@)
    set(ARG_TEST_CASE @ARG_TEST_CASE@)
    set(ARG_TEST_SCRIPT @ARG_TEST_SCRIPT@)
    set(ARG_TEST_COMMAND @ARG_TEST_COMMAND@)
    set(ARG_VERIFY_SCRIPT @ARG_VERIFY_SCRIPT@)
    set(ARG_VERIFY_COMMAND @ARG_VERIFY_COMMAND@)

    # Run test phase

    if(ARG_TEST_SCRIPT)
        # TODO check availability of script
        string(MAKE_C_IDENTIFIER "${ARG_TEST_SCRIPT}" SCRIPT_ID)
        get_filename_component(SCRIPT_PATH "${ARG_TEST_SCRIPT}" ABSOLUTE)
        get_filename_component(SCRIPT_DIRECTORY "${SCRIPT_PATH}" DIRECTORY)
        set(CFORGE_UNIT_CURRENT_TEST_OUTPUT_FILE ${CMAKE_CURRENT_BINARY_DIR}/${SCRIPT_ID}.output.txt)
        set(CFORGE_UNIT_CURRENT_TEST_ERROR_FILE ${CMAKE_CURRENT_BINARY_DIR}/${SCRIPT_ID}.error.txt)
        execute_process(
            COMMAND ${CMAKE_COMMAND} -P ${ARG_TEST_SCRIPT}
            WORKING_DIRECTORY "${SCRIPT_DIRECTORY}"
            OUTPUT_FILE ${CFORGE_UNIT_CURRENT_TEST_OUTPUT_FILE}
            ERROR_FILE ${CFORGE_UNIT_CURRENT_TEST_ERROR_FILE}
            RESULT_VARIABLE TEST_RESULT
        )
        if(NOT ARG_TEST_SHALL_FAIL AND NOT TEST_RESULT EQUAL 0)
            # Script/command failed but was expected to pass
            message(SEND_ERROR "Test failed with code ${TEST_RESULT} (expected: code == 0)")
            set(TEST_FAILED YES)
        elseif(ARG_TEST_SHALL_FAIL AND TEST_RESULT EQUAL 0)
            # Script/command passed but was expected to fail
            message(SEND_ERROR "Test failed with code ${TEST_RESULT} (expected: code != 0)")
            set(TEST_FAILED YES)
        endif()
    endif()

    if(ARG_TEST_COMMAND)
        if(COMMAND ${ARG_TEST_COMMAND})
            cmake_language(CALL ${ARG_TEST_COMMAND} TEST_RESULT)
            if(TEST_RESULT AND NOT TEST_RESULT EQUAL 0)
                set(TEST_FAILED YES)
            endif()
        else()
            message(FATAL_ERROR "Argument TEST_COMMAND is not a known CMake command (${ARG_TEST_COMMAND}).")
        endif()
    endif()

    # Run verification phase

    if(ARG_VERIFY_SCRIPT)
        # TODO check availability of script
        string(MAKE_C_IDENTIFIER "${ARG_VERIFY_SCRIPT}" SCRIPT_ID)
        get_filename_component(SCRIPT_PATH "${ARG_VERIFY_SCRIPT}" ABSOLUTE)
        get_filename_component(SCRIPT_DIRECTORY "${SCRIPT_PATH}" DIRECTORY)
        set(CFORGE_UNIT_CURRENT_VERIFY_OUTPUT_FILE ${CMAKE_CURRENT_BINARY_DIR}/${SCRIPT_ID}.output.txt)
        set(CFORGE_UNIT_CURRENT_VERIFY_ERROR_FILE ${CMAKE_CURRENT_BINARY_DIR}/${SCRIPT_ID}.error.txt)
        execute_process(
            COMMAND ${CMAKE_COMMAND}
                -D CFORGE_UNIT_CURRENT_TEST_OUTPUT_FILE=${CFORGE_UNIT_CURRENT_TEST_OUTPUT_FILE}
                -D CFORGE_UNIT_CURRENT_TEST_ERROR_FILE=${CFORGE_UNIT_CURRENT_TEST_ERROR_FILE}
                -P ${ARG_VERIFY_SCRIPT}
            WORKING_DIRECTORY "${SCRIPT_DIRECTORY}"
            OUTPUT_FILE ${CFORGE_UNIT_CURRENT_VERIFY_OUTPUT_FILE}
            ERROR_FILE ${CFORGE_UNIT_CURRENT_VERIFY_ERROR_FILE}
            RESULT_VARIABLE VERIFY_RESULT
        )
        if(VERIFY_RESULT AND NOT VERIFY_RESULT EQUAL 0)
            set(VERIFY_FAILED YES)
        endif()
    endif()

    if(ARG_VERIFY_COMMAND)
        if(COMMAND ${ARG_VERIFY_COMMAND})
            cmake_language(CALL ${ARG_VERIFY_COMMAND} VERIFY_RESULT)
            if(VERIFY_RESULT AND NOT VERIFY_RESULT EQUAL 0)
                set(VERIFY_FAILED YES)
            endif()
        else()
            message(FATAL_ERROR "Argument VERIFY_COMMAND is not a known CMake command (${ARG_VERIFY_COMMAND}).")
        endif()
    endif()

    # Print test verdict

    if(TEST_FAILED OR VERIFY_FAILED)
        _cforge_unit_report_verdict_failed(${ARG_TEST_SUITE} ${ARG_TEST_CASE})
    else()
        _cforge_unit_report_verdict_passed(${ARG_TEST_SUITE} ${ARG_TEST_CASE})
    endif()
endfunction()
